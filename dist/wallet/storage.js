"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Storage = void 0;
const logger_1 = require("../utils/logger");
const helper_1 = require("../utils/helper");
const IS_NODE = typeof process === 'object'
    && typeof process.versions === 'object'
    && typeof process.versions.node === 'string';
class DBInterface {
}
const classes = {};
class LSDB extends DBInterface {
    constructor(opt = {}) {
        super();
        this.LS = window.localStorage;
    }
    backup() {
        let data = this.getWallet();
        if (!data)
            return;
        let ts = Date.now();
        this.LS.setItem("kaspa-wallet-" + ts, data);
        let cache = this.getCache();
        if (cache)
            this.LS.setItem("kaspa-cache-" + ts, cache);
    }
    saveWallet(data) {
        this.LS.setItem("kaspa-wallet", data);
    }
    getWallet() {
        return this.LS.getItem("kaspa-wallet");
    }
    saveCache(cache) {
        return this.LS.setItem("kaspa-cache", cache);
    }
    getCache() {
        return this.LS.getItem("kaspa-cache");
    }
}
classes.LSDB = LSDB;
if (IS_NODE) {
    const path = require("path");
    const os = require("os");
    const fs = require("fs");
    class FileDB extends DBInterface {
        constructor(opt = {}) {
            super();
            let { fileName = "kaspa", folder } = opt;
            this.fileName = fileName;
            this.folder = folder || this.getHomeFolder();
            if (!fs.existsSync(this.folder))
                fs.mkdirSync(this.folder, { recursive: true });
            this.walletFile = this.createFilePath('kpk');
            this.txFile = this.createFilePath('ktx');
            this.cacheFile = this.createFilePath('cache');
        }
        createFilePath(ext = 'kpk', suffix = '') {
            return path.join(this.folder, `${this.fileName}${suffix}.${ext}`);
        }
        getHomeFolder() {
            let { APPDATA, HOME } = process.env;
            if (!HOME)
                HOME = os.homedir();
            if (APPDATA) // windows
                return path.join(APPDATA, 'Kaspa');
            if (process.platform == 'darwin')
                return path.join(HOME, '/Library/Application Support/Kaspa/');
            return path.join(HOME, '.kaspa');
        }
        backup() {
            let bk = '-backup-' + (0, helper_1.UID)("-");
            if (fs.existsSync(this.walletFile)) {
                let newPath = this.createFilePath('kpk', bk);
                fs.renameSync(this.walletFile, newPath);
            }
            if (fs.existsSync(this.txFile)) {
                let newPath = this.createFilePath('ktx', bk);
                fs.renameSync(this.txFile, newPath);
            }
            if (fs.existsSync(this.cacheFile)) {
                let newPath = this.createFilePath('cache', bk);
                fs.renameSync(this.cacheFile, newPath);
            }
        }
        saveWallet(data) {
            fs.writeFileSync(this.walletFile, data);
        }
        getWallet() {
            if (fs.existsSync(this.walletFile))
                return fs.readFileSync(this.walletFile) + "";
            return false;
        }
        saveCache(cache) {
            return fs.writeFileSync(this.cacheFile, cache);
        }
        getCache() {
            if (fs.existsSync(this.cacheFile))
                return fs.readFileSync(this.cacheFile) + "";
            return undefined;
        }
    }
    classes.FileDB = FileDB;
}
class Storage {
    constructor(opt = {}) {
        this.logger = (0, logger_1.CreateLogger)("KaspaStorage");
        const { fileDbOptions = {} } = opt;
        if (opt.logLevel)
            this.setLogLevel(opt.logLevel);
        if (IS_NODE) {
            this.db = new classes.FileDB(fileDbOptions);
        }
        else {
            this.db = new classes.LSDB();
        }
    }
    /*
    * @return {String|Buffer} wallet
    */
    getWallet() {
        let content = this.db.getWallet();
        if (!content)
            return false;
        try {
            return JSON.parse(content);
        }
        catch (e) {
            return false;
        }
    }
    _buildWalletContent(mnemonic, meta = {}) {
        return Object.assign({
            type: "kaspa-wallet",
            encryption: "default",
            version: 1,
            generator: "cli",
            wallet: {
                mnemonic
            }
        }, meta || {});
    }
    createWallet(mnemonic, meta = {}) {
        //this.logger.debug("createWallet:", wallet)
        this.db.backup();
        this.db.saveCache('');
        return this.saveWallet(mnemonic, meta);
    }
    saveWallet(mnemonic, meta = {}) {
        //this.logger.debug("saveWallet:", wallet)
        let wallet = this._buildWalletContent(mnemonic, meta);
        let json = JSON.stringify(wallet);
        return this.db.saveWallet(json);
    }
    /*
    * @return {WalletCache|undefined} cache
    */
    getCache() {
        let cache = this.db.getCache();
        if (!cache)
            return false;
        try {
            return JSON.parse(cache);
        }
        catch (e) {
            return false;
        }
    }
    saveCache(cache) {
        let data = JSON.stringify(cache);
        this.db.saveCache(data);
    }
    setLogLevel(level) {
        this.logger.setLevel(level);
    }
    addTransaction(tx) {
    }
}
exports.Storage = Storage;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3dhbGxldC9zdG9yYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDRDQUFxRDtBQUNyRCw0Q0FBb0M7QUFJcEMsTUFBTSxPQUFPLEdBQUcsT0FBTyxPQUFPLEtBQUssUUFBUTtPQUN2QyxPQUFPLE9BQU8sQ0FBQyxRQUFRLEtBQUssUUFBUTtPQUNwQyxPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQztBQXNDOUMsTUFBZSxXQUFXO0NBTXpCO0FBT0QsTUFBTSxPQUFPLEdBQWdDLEVBQUUsQ0FBQztBQUVoRCxNQUFNLElBQUssU0FBUSxXQUFXO0lBRTdCLFlBQVksTUFBYyxFQUFFO1FBQzNCLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLEVBQUUsR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDO0lBQy9CLENBQUM7SUFFRCxNQUFNO1FBQ0wsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQzVCLElBQUcsQ0FBQyxJQUFJO1lBQ1AsT0FBTTtRQUNQLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxlQUFlLEdBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzFDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUM1QixJQUFHLEtBQUs7WUFDUCxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxjQUFjLEdBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFDRCxVQUFVLENBQUMsSUFBVztRQUNyQixJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVELFNBQVM7UUFDUixPQUFP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QUM7SUFFRCxXQUFXLENBQUMsS0FBWTtRQUN2QixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUM1QixDQUFDO0lBRUQsY0FBYyxDQUFDLEVBQWM7SUFFN0IsQ0FBQztDQUNEO0FBcEZELDBCQW9GQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q3JlYXRlTG9nZ2VyLCBMb2dnZXJ9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQge1VJRH0gZnJvbSAnLi4vdXRpbHMvaGVscGVyJztcbmltcG9ydCB7IFdhbGxldENhY2hlIH0gZnJvbSAnLi4vdHlwZXMvY3VzdG9tLXR5cGVzJztcblxuZXhwb3J0IHR5cGUgU3RvcmFnZVR5cGUgPSAnRklMRSd8J0xTJztcbmNvbnN0IElTX05PREUgPSB0eXBlb2YgcHJvY2VzcyA9PT0gJ29iamVjdCcgXG5cdCYmIHR5cGVvZiBwcm9jZXNzLnZlcnNpb25zID09PSAnb2JqZWN0J1xuXHQmJiB0eXBlb2YgcHJvY2Vzcy52ZXJzaW9ucy5ub2RlID09PSAnc3RyaW5nJztcblxuZXhwb3J0IHR5cGUgU3RvcmFnZU9wdHMgPSB7XG5cdGxvZ0xldmVsPzpzdHJpbmcsXG5cdHBhc3N3b3JkPzpzdHJpbmcsXG5cdGZpbGVEYk9wdGlvbnM/Ontcblx0XHRmaWxlTmFtZT86c3RyaW5nLFxuXHRcdGZvbGRlcj86c3RyaW5nXG5cdH1cbn07XG5leHBvcnQgaW50ZXJmYWNlIFRYU3RvcmVJdGVte1xuXHRpbjpib29sZWFuO1xuXHR0czpudW1iZXI7XG5cdGlkOnN0cmluZztcblx0YW1vdW50Om51bWJlcjtcblx0YWRkcmVzczpzdHJpbmc7XG5cdG5vdGU/OnN0cmluZztcblx0dHg/OmFueVxufVxuZXhwb3J0IGludGVyZmFjZSBXYWxsZXRNZXRhe1xuXHR2ZXJzaW9uPzpzdHJpbmc7XG5cdGdlbmVyYXRvcj86c3RyaW5nO1xuXHRlbmNyeXB0aW9uPzpzdHJpbmc7XG5cdHdhbGxldD86e21uZW1vbmljPzpzdHJpbmd9XG59XG5leHBvcnQgaW50ZXJmYWNlIFdhbGxldENvbnRlbnR7XG5cdHR5cGU6c3RyaW5nO1xuXHR2ZXJzaW9uOnN0cmluZztcblx0Z2VuZXJhdG9yOnN0cmluZztcblx0ZW5jcnlwdGlvbjpzdHJpbmc7XG5cdHdhbGxldDp7bW5lbW9uaWM6c3RyaW5nfVxufVxuXG5pbnRlcmZhY2UgREJPcHRpb25ze1xuXHRmaWxlTmFtZT86c3RyaW5nLFxuXHRmb2xkZXI/OnN0cmluZ1xufVxuXG5hYnN0cmFjdCBjbGFzcyBEQkludGVyZmFjZXtcblx0YWJzdHJhY3QgYmFja3VwKCk6dm9pZDtcblx0YWJzdHJhY3Qgc2F2ZVdhbGxldChkYXRhOnN0cmluZyk6dm9pZDtcblx0YWJzdHJhY3QgZ2V0V2FsbGV0KCk6c3RyaW5nfGZhbHNlO1xuXHRhYnN0cmFjdCBnZXRDYWNoZSgpOnN0cmluZ3x1bmRlZmluZWQ7XG5cdGFic3RyYWN0IHNhdmVDYWNoZShjYWNoZTpzdHJpbmcpOnZvaWRcbn1cblxuaW50ZXJmYWNlIERCQ29uc3RydWN0b3Ige1xuICAgIG5ldyAob3B0PzpEQk9wdGlvbnMpOiBEQkludGVyZmFjZTtcbn1cblxuXG5jb25zdCBjbGFzc2VzOntba2V5OnN0cmluZ106REJDb25zdHJ1Y3Rvcn0gPSB7fTtcblxuY2xhc3MgTFNEQiBleHRlbmRzIERCSW50ZXJmYWNle1xuXHRMUzogYW55O1xuXHRjb25zdHJ1Y3RvcihvcHQ6REJPcHRpb25zPXt9KXtcblx0XHRzdXBlcigpO1xuXHRcdHRoaXMuTFMgPSB3aW5kb3cubG9jYWxTdG9yYWdlO1xuXHR9XG5cblx0YmFja3VwKCk6dm9pZHtcblx0XHRsZXQgZGF0YSA9IHRoaXMuZ2V0V2FsbGV0KCk7XG5cdFx0aWYoIWRhdGEpXG5cdFx0XHRyZXR1cm5cblx0XHRsZXQgdHMgPSBEYXRlLm5vdygpO1xuXHRcdHRoaXMuTFMuc2V0SXRlbShcImthc3BhLXdhbGxldC1cIit0cywgZGF0YSk7XG5cdFx0bGV0IGNhY2hlID0gdGhpcy5nZXRDYWNoZSgpO1xuXHRcdGlmKGNhY2hlKVxuXHRcdFx0dGhpcy5MUy5zZXRJdGVtKFwia2FzcGEtY2FjaGUtXCIrdHMsIGNhY2hlKTtcblx0fVxuXHRzYXZlV2FsbGV0KGRhdGE6c3RyaW5nKTp2b2lke1xuXHRcdHRoaXMuTFMuc2V0SXRlbShcImthc3BhLXdhbGxldFwiLCBkYXRhKTtcblx0fVxuXG5cdGdldFdhbGxldCgpOnN0cmluZ3xmYWxzZXtcblx0XHRyZXR1cm4gdGhpcy5MUy5nZXRJdGVtKFwia2FzcGEtd2FsbGV0XCIpO1xuXHR9XG5cblx0c2F2ZUNhY2hlKGNhY2hlOnN0cmluZyl7XG5cdFx0cmV0dXJuIHRoaXMuTFMuc2V0SXRlbShcImthc3BhLWNhY2hlXCIsIGNhY2hlKTtcblx0fVxuXG5cdGdldENhY2hlKCk6c3RyaW5nfHVuZGVmaW5lZHtcblx0XHRyZXR1cm4gdGhpcy5MUy5nZXRJdGVtKFwia2FzcGEtY2FjaGVcIik7XG5cdH1cbn1cblxuY2xhc3Nlcy5MU0RCID0gTFNEQjtcblxuaWYoSVNfTk9ERSl7XG5cdGNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcblx0Y29uc3Qgb3MgPSByZXF1aXJlKFwib3NcIik7XG5cdGNvbnN0IGZzID0gcmVxdWlyZShcImZzXCIpO1xuXG5cdGNsYXNzIEZpbGVEQiBleHRlbmRzIERCSW50ZXJmYWNle1xuXHRcdHdhbGxldEZpbGU6c3RyaW5nO1xuXHRcdHR4RmlsZTpzdHJpbmc7XG5cdFx0ZmlsZU5hbWU6c3RyaW5nO1xuXHRcdGZvbGRlcjpzdHJpbmc7XG5cdFx0Y2FjaGVGaWxlOnN0cmluZztcblxuXHRcdGNvbnN0cnVjdG9yKG9wdDpEQk9wdGlvbnM9e30pe1xuXHRcdFx0c3VwZXIoKTtcblx0XHRcdGxldCB7ZmlsZU5hbWU9XCJrYXNwYVwiLCBmb2xkZXJ9ID0gb3B0O1xuXHRcdFx0dGhpcy5maWxlTmFtZSA9IGZpbGVOYW1lO1xuXHRcdFx0dGhpcy5mb2xkZXIgPSBmb2xkZXJ8fHRoaXMuZ2V0SG9tZUZvbGRlcigpO1xuXHRcdFx0aWYoIWZzLmV4aXN0c1N5bmModGhpcy5mb2xkZXIpKVxuXHRcdFx0XHRmcy5ta2RpclN5bmModGhpcy5mb2xkZXIsIHtyZWN1cnNpdmU6dHJ1ZX0pXG5cdFx0XHR0aGlzLndhbGxldEZpbGUgPSB0aGlzLmNyZWF0ZUZpbGVQYXRoKCdrcGsnKTtcblx0XHRcdHRoaXMudHhGaWxlID0gdGhpcy5jcmVhdGVGaWxlUGF0aCgna3R4Jyk7XG5cdFx0XHR0aGlzLmNhY2hlRmlsZSA9IHRoaXMuY3JlYXRlRmlsZVBhdGgoJ2NhY2hlJyk7XG5cdFx0fVxuXG5cdFx0Y3JlYXRlRmlsZVBhdGgoZXh0PSdrcGsnLCBzdWZmaXg9Jycpe1xuXHRcdFx0cmV0dXJuIHBhdGguam9pbih0aGlzLmZvbGRlciwgYCR7dGhpcy5maWxlTmFtZX0ke3N1ZmZpeH0uJHtleHR9YCk7XG5cdFx0fVxuXG5cdFx0Z2V0SG9tZUZvbGRlcigpe1xuXHRcdFx0bGV0IHtBUFBEQVRBLCBIT01FfSA9IHByb2Nlc3MuZW52O1xuXHRcdFx0aWYoIUhPTUUpXG5cdFx0XHRcdEhPTUUgPSBvcy5ob21lZGlyKCk7XG5cblx0XHRcdGlmKEFQUERBVEEpIC8vIHdpbmRvd3Ncblx0XHRcdFx0cmV0dXJuIHBhdGguam9pbihBUFBEQVRBLCAnS2FzcGEnKTtcblxuXHRcdFx0aWYocHJvY2Vzcy5wbGF0Zm9ybSA9PSAnZGFyd2luJylcblx0XHRcdFx0cmV0dXJuIHBhdGguam9pbihIT01FLCcvTGlicmFyeS9BcHBsaWNhdGlvbiBTdXBwb3J0L0thc3BhLycpO1xuXG5cdFx0XHRyZXR1cm4gcGF0aC5qb2luKEhPTUUsICcua2FzcGEnKTtcblx0XHR9XG5cblx0XHRiYWNrdXAoKXtcblx0XHRcdGxldCBiayA9ICctYmFja3VwLScrVUlEKFwiLVwiKTtcblxuXHRcdFx0aWYoZnMuZXhpc3RzU3luYyh0aGlzLndhbGxldEZpbGUpKXtcblx0XHRcdFx0bGV0IG5ld1BhdGggPSB0aGlzLmNyZWF0ZUZpbGVQYXRoKCdrcGsnLCBiaylcblx0XHRcdFx0ZnMucmVuYW1lU3luYyh0aGlzLndhbGxldEZpbGUsIG5ld1BhdGgpO1xuXHRcdFx0fVxuXHRcdFx0aWYoZnMuZXhpc3RzU3luYyh0aGlzLnR4RmlsZSkpe1xuXHRcdFx0XHRsZXQgbmV3UGF0aCA9IHRoaXMuY3JlYXRlRmlsZVBhdGgoJ2t0eCcsIGJrKVxuXHRcdFx0XHRmcy5yZW5hbWVTeW5jKHRoaXMudHhGaWxlLCBuZXdQYXRoKTtcblx0XHRcdH1cblx0XHRcdGlmKGZzLmV4aXN0c1N5bmModGhpcy5jYWNoZUZpbGUpKXtcblx0XHRcdFx0bGV0IG5ld1BhdGggPSB0aGlzLmNyZWF0ZUZpbGVQYXRoKCdjYWNoZScsIGJrKVxuXHRcdFx0XHRmcy5yZW5hbWVTeW5jKHRoaXMuY2FjaGVGaWxlLCBuZXdQYXRoKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRzYXZlV2FsbGV0KGRhdGE6c3RyaW5nKTp2b2lke1xuXHRcdFx0ZnMud3JpdGVGaWxlU3luYyh0aGlzLndhbGxldEZpbGUsIGRhdGEpO1xuXHRcdH1cblxuXHRcdGdldFdhbGxldCgpOnN0cmluZ3xmYWxzZXtcblx0XHRcdGlmKGZzLmV4aXN0c1N5bmModGhpcy53YWxsZXRGaWxlKSlcblx0XHRcdFx0cmV0dXJuIGZzLnJlYWRGaWxlU3luYyh0aGlzLndhbGxldEZpbGUpK1wiXCI7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fVxuXG5cdFx0c2F2ZUNhY2hlKGNhY2hlOnN0cmluZyl7XG5cdFx0XHRyZXR1cm4gZnMud3JpdGVGaWxlU3luYyh0aGlzLmNhY2hlRmlsZSwgY2FjaGUpO1xuXHRcdH1cblx0XG5cdFx0Z2V0Q2FjaGUoKTpzdHJpbmd8dW5kZWZpbmVke1xuXHRcdFx0aWYoZnMuZXhpc3RzU3luYyh0aGlzLmNhY2hlRmlsZSkpXG5cdFx0XHRcdHJldHVybiBmcy5yZWFkRmlsZVN5bmModGhpcy5jYWNoZUZpbGUpK1wiXCI7XG5cdFx0XHRyZXR1cm4gdW5kZWZpbmVkO1xuXHRcdH1cblx0fVxuXG5cdGNsYXNzZXMuRmlsZURCID0gRmlsZURCO1xufVxuXG5leHBvcnQgY2xhc3MgU3RvcmFnZXtcblxuXHRsb2dnZXI6YW55O1xuXHRkYjpEQkludGVyZmFjZTtcblx0Y29uc3RydWN0b3Iob3B0OlN0b3JhZ2VPcHRzPXt9KXtcblx0XHR0aGlzLmxvZ2dlciA9IENyZWF0ZUxvZ2dlcihcIkthc3BhU3RvcmFnZVwiKTtcblx0XHRjb25zdCB7ZmlsZURiT3B0aW9ucz17fX0gPSBvcHQ7XG5cblx0XHRpZihvcHQubG9nTGV2ZWwpXG5cdFx0XHR0aGlzLnNldExvZ0xldmVsKG9wdC5sb2dMZXZlbClcblxuXHRcdGlmKElTX05PREUpe1xuXHRcdFx0dGhpcy5kYiA9IG5ldyBjbGFzc2VzLkZpbGVEQihmaWxlRGJPcHRpb25zKTtcblx0XHR9ZWxzZXtcblx0XHRcdHRoaXMuZGIgPSBuZXcgY2xhc3Nlcy5MU0RCKCk7XG5cdFx0fVxuXHR9XG5cblx0Lypcblx0KiBAcmV0dXJuIHtTdHJpbmd8QnVmZmVyfSB3YWxsZXRcblx0Ki9cblx0Z2V0V2FsbGV0KCk6V2FsbGV0Q29udGVudHxmYWxzZXtcblx0XHRsZXQgY29udGVudCA9IHRoaXMuZGIuZ2V0V2FsbGV0KCk7XG5cdFx0aWYoIWNvbnRlbnQpXG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0dHJ5e1xuXHRcdFx0cmV0dXJuIEpTT04ucGFyc2UoY29udGVudCk7XG5cdFx0fWNhdGNoKGUpe1xuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblx0fVxuXG5cdF9idWlsZFdhbGxldENvbnRlbnQobW5lbW9uaWM6c3RyaW5nLCBtZXRhOldhbGxldE1ldGE9e30pe1xuXHRcdHJldHVybiBPYmplY3QuYXNzaWduKHtcblx0XHRcdHR5cGU6IFwia2FzcGEtd2FsbGV0XCIsXG5cdFx0XHRlbmNyeXB0aW9uOiBcImRlZmF1bHRcIixcblx0XHRcdHZlcnNpb246IDEsXG5cdFx0XHRnZW5lcmF0b3I6IFwiY2xpXCIsXG5cdFx0XHR3YWxsZXQ6IHtcblx0XHRcdFx0bW5lbW9uaWNcblx0XHRcdH1cblx0XHR9LCBtZXRhfHx7fSlcblx0fVxuXG5cdGNyZWF0ZVdhbGxldChtbmVtb25pYzpzdHJpbmcsIG1ldGE6V2FsbGV0TWV0YT17fSl7XG5cdFx0Ly90aGlzLmxvZ2dlci5kZWJ1ZyhcImNyZWF0ZVdhbGxldDpcIiwgd2FsbGV0KVxuXHRcdHRoaXMuZGIuYmFja3VwKCk7XG5cdFx0dGhpcy5kYi5zYXZlQ2FjaGUoJycpXG5cdFx0cmV0dXJuIHRoaXMuc2F2ZVdhbGxldChtbmVtb25pYywgbWV0YSk7XG5cdH1cblx0c2F2ZVdhbGxldChtbmVtb25pYzpzdHJpbmcsIG1ldGE6V2FsbGV0TWV0YT17fSl7XG5cdFx0Ly90aGlzLmxvZ2dlci5kZWJ1ZyhcInNhdmVXYWxsZXQ6XCIsIHdhbGxldClcblx0XHRsZXQgd2FsbGV0ID0gdGhpcy5fYnVpbGRXYWxsZXRDb250ZW50KG1uZW1vbmljLCBtZXRhKTtcblx0XHRsZXQganNvbiA9IEpTT04uc3RyaW5naWZ5KHdhbGxldClcblx0XHRyZXR1cm4gdGhpcy5kYi5zYXZlV2FsbGV0KGpzb24pO1xuXHR9XG5cblx0Lypcblx0KiBAcmV0dXJuIHtXYWxsZXRDYWNoZXx1bmRlZmluZWR9IGNhY2hlXG5cdCovXG5cdGdldENhY2hlKCk6V2FsbGV0Q2FjaGV8ZmFsc2V7XG5cdFx0bGV0IGNhY2hlID0gdGhpcy5kYi5nZXRDYWNoZSgpO1xuXHRcdGlmKCFjYWNoZSlcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcblx0XHR0cnl7XG5cdFx0XHRyZXR1cm4gSlNPTi5wYXJzZShjYWNoZSk7XG5cdFx0fWNhdGNoKGUpe1xuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblx0fVxuXG5cdHNhdmVDYWNoZShjYWNoZTpXYWxsZXRDYWNoZSl7XG5cdFx0bGV0IGRhdGEgPSBKU09OLnN0cmluZ2lmeShjYWNoZSk7XG5cdFx0dGhpcy5kYi5zYXZlQ2FjaGUoZGF0YSk7XG5cdH1cblxuXHRzZXRMb2dMZXZlbChsZXZlbDpzdHJpbmcpe1xuXHRcdHRoaXMubG9nZ2VyLnNldExldmVsKGxldmVsKVxuXHR9XG5cblx0YWRkVHJhbnNhY3Rpb24odHg6VFhTdG9yZUl0ZW0pe1xuXG5cdH1cbn1cblxuXG4iXX0=